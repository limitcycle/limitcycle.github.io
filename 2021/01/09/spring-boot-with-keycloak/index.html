<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>使用Keycloak保護Spring Boot REST服務 - limitcycle&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="limitcycle&#039;s blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="limitcycle&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="對於任何應用程序，安全性始終是主要的跨領域關注點。傳統上，我們過去在整體後端服務中只有一個安全層來保護所有前端應用程序請求。隨著新興的微服務架構的發展，不再有單一的後端服務。前端應用程序調用多個後端服務，這些服務又可以調用其他服務。不再有可以處理身份驗證的單層。由於微服務都具有許多較小的服務，每個服務都處理一個不同的職責，因此安全性的明顯解決方案是身份驗證和授權服務。這是Keycloak進行救援的"><meta property="og:type" content="blog"><meta property="og:title" content="使用Keycloak保護Spring Boot REST服務"><meta property="og:url" content="https://limitcycle.github.io/2021/01/09/spring-boot-with-keycloak/"><meta property="og:site_name" content="limitcycle&#039;s blog"><meta property="og:description" content="對於任何應用程序，安全性始終是主要的跨領域關注點。傳統上，我們過去在整體後端服務中只有一個安全層來保護所有前端應用程序請求。隨著新興的微服務架構的發展，不再有單一的後端服務。前端應用程序調用多個後端服務，這些服務又可以調用其他服務。不再有可以處理身份驗證的單層。由於微服務都具有許多較小的服務，每個服務都處理一個不同的職責，因此安全性的明顯解決方案是身份驗證和授權服務。這是Keycloak進行救援的"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://i.imgur.com/0lR0sVR.png"><meta property="og:image" content="https://i.imgur.com/3GNGILZ.png"><meta property="og:image" content="https://i.imgur.com/c5dRXaZ.png"><meta property="og:image" content="https://i.imgur.com/7nZSwLR.png"><meta property="og:image" content="https://i.imgur.com/5iS9L10.png"><meta property="og:image" content="https://i.imgur.com/sFDqA9O.png"><meta property="og:image" content="https://i.imgur.com/LSYaOT8.png"><meta property="og:image" content="https://i.imgur.com/WhYm21L.png"><meta property="og:image" content="https://i.imgur.com/7MM55ib.png"><meta property="og:image" content="https://i.imgur.com/sH6EtKT.png"><meta property="og:image" content="https://i.imgur.com/hSbshmr.png"><meta property="og:image" content="https://i.imgur.com/MNP17PY.png"><meta property="og:image" content="https://i.imgur.com/fg1mWxz.png"><meta property="og:image" content="https://i.imgur.com/TCFK9gy.png"><meta property="og:image" content="https://i.imgur.com/E66DlEQ.png"><meta property="og:image" content="https://i.imgur.com/HtT11cE.png"><meta property="og:image" content="https://i.imgur.com/UGSiFEc.png"><meta property="og:image" content="https://i.imgur.com/W7IuZY1.png"><meta property="og:image" content="https://i.imgur.com/NDXsvJF.png"><meta property="og:image" content="https://i.imgur.com/vFO75lm.png"><meta property="og:image" content="https://i.imgur.com/wWeya3q.png"><meta property="og:image" content="https://i.imgur.com/n5fT74P.png"><meta property="og:image" content="https://i.imgur.com/jYHeijY.png"><meta property="og:image" content="https://i.imgur.com/LcXn2sM.png"><meta property="og:image" content="https://i.imgur.com/WlKirk0.png"><meta property="og:image" content="https://i.imgur.com/KBPLQkc.png"><meta property="og:image" content="https://i.imgur.com/azfW1CZ.png"><meta property="og:image" content="https://i.imgur.com/C5RhXU5.png"><meta property="og:image" content="https://i.imgur.com/0Zh2NNo.png"><meta property="og:image" content="https://i.imgur.com/LVoVTJu.png"><meta property="og:image" content="https://i.imgur.com/NSQjvjO.png"><meta property="og:image" content="https://i.imgur.com/6FKkNbw.png"><meta property="og:image" content="https://i.imgur.com/H1PDuxz.png"><meta property="article:published_time" content="2021-01-09T08:33:29.000Z"><meta property="article:modified_time" content="2021-01-17T20:25:51.152Z"><meta property="article:author" content="limitcycle"><meta property="article:tag" content="spring"><meta property="article:tag" content="keycloak"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://i.imgur.com/0lR0sVR.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://limitcycle.github.io/2021/01/09/spring-boot-with-keycloak/"},"headline":"limitcycle's blog","image":["https://i.imgur.com/0lR0sVR.png","https://i.imgur.com/3GNGILZ.png","https://i.imgur.com/c5dRXaZ.png","https://i.imgur.com/7nZSwLR.png","https://i.imgur.com/5iS9L10.png","https://i.imgur.com/sFDqA9O.png","https://i.imgur.com/LSYaOT8.png","https://i.imgur.com/WhYm21L.png","https://i.imgur.com/7MM55ib.png","https://i.imgur.com/sH6EtKT.png","https://i.imgur.com/hSbshmr.png","https://i.imgur.com/MNP17PY.png","https://i.imgur.com/fg1mWxz.png","https://i.imgur.com/TCFK9gy.png","https://i.imgur.com/E66DlEQ.png","https://i.imgur.com/HtT11cE.png","https://i.imgur.com/UGSiFEc.png","https://i.imgur.com/W7IuZY1.png","https://i.imgur.com/NDXsvJF.png","https://i.imgur.com/vFO75lm.png","https://i.imgur.com/wWeya3q.png","https://i.imgur.com/n5fT74P.png","https://i.imgur.com/jYHeijY.png","https://i.imgur.com/LcXn2sM.png","https://i.imgur.com/WlKirk0.png","https://i.imgur.com/KBPLQkc.png","https://i.imgur.com/azfW1CZ.png","https://i.imgur.com/C5RhXU5.png","https://i.imgur.com/0Zh2NNo.png","https://i.imgur.com/LVoVTJu.png","https://i.imgur.com/NSQjvjO.png","https://i.imgur.com/6FKkNbw.png","https://i.imgur.com/H1PDuxz.png"],"datePublished":"2021-01-09T08:33:29.000Z","dateModified":"2021-01-17T20:25:51.152Z","author":{"@type":"Person","name":"limitcycle"},"description":"對於任何應用程序，安全性始終是主要的跨領域關注點。傳統上，我們過去在整體後端服務中只有一個安全層來保護所有前端應用程序請求。隨著新興的微服務架構的發展，不再有單一的後端服務。前端應用程序調用多個後端服務，這些服務又可以調用其他服務。不再有可以處理身份驗證的單層。由於微服務都具有許多較小的服務，每個服務都處理一個不同的職責，因此安全性的明顯解決方案是身份驗證和授權服務。這是Keycloak進行救援的"}</script><link rel="canonical" href="https://limitcycle.github.io/2021/01/09/spring-boot-with-keycloak/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">limitcycle&#039;s blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/limitcycle/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜尋" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-09T08:33:29.000Z" title="1/9/2021, 8:33:29 AM">2021-01-09</time>發表</span><span class="level-item"><time dateTime="2021-01-17T20:25:51.152Z" title="1/17/2021, 8:25:51 PM">2021-01-18</time>更新</span><span class="level-item">20 分鐘讀完 (大約3002個字)</span></div></div><h1 class="title is-3 is-size-4-mobile">使用Keycloak保護Spring Boot REST服務</h1><div class="content"><p>對於任何應用程序，安全性始終是主要的跨領域關注點。傳統上，我們過去在整體後端服務中只有一個安全層來保護所有前端應用程序請求。隨著新興的微服務架構的發展，不再有單一的後端服務。前端應用程序調用多個後端服務，這些服務又可以調用其他服務。不再有可以處理身份驗證的單層。由於微服務都具有許多較小的服務，每個服務都處理一個不同的職責，因此安全性的明顯解決方案是身份驗證和授權服務。這是Keycloak進行救援的地方，因為它提供了保護微服務所需的功能。</p>
<a id="more"></a>

<h1 id="什麼是Keycloak"><a href="#什麼是Keycloak" class="headerlink" title="什麼是Keycloak"></a>什麼是Keycloak</h1><p>Keycloak是Red Hat贊助的開源身份和訪問管理（IAM）解決方案。它使我們能夠保護各種現代的前端應用程序和後端服務。Keycloak可以毫不費力地為我們的應用程序和服務添加身份驗證和授權。我們不需要處理用戶的存儲或身份驗證，因為所有這些都可以在Keycloak中直接使用。</p>
<p>Keycloak提供的功能包括單點登錄（SSO），身份代理和社交登錄，用戶聯合，客戶端適配器，管理員和用戶帳戶管理控制台。</p>
<p><img src="https://i.imgur.com/0lR0sVR.png"></p>
<p>除了這些基本功能，Keycloak在其他IAM解決方案中脫穎而出的原因還在於其可定制的網頁和電子郵件模板主題，以及可擴展的功能和領域。可定制的主題很重要，因為它們使開發人員可以定制面向最終用戶的網頁的外觀，以便可以將其與應用程序緊密集成。Keycloak還提供了擴展其核心功能和範圍的功能。這包括可能：</p>
<ul>
<li>將自定義REST端點添加到Keycloak服務器</li>
<li>添加 Server Provider Interface(SPI)</li>
<li>將自定義 Java Persistence API(JPA)實體添加到Keycloak數據模型中</li>
</ul>
<h1 id="設置Keycloak"><a href="#設置Keycloak" class="headerlink" title="設置Keycloak"></a>設置Keycloak</h1><p>以下安裝並運行Keycloak服務器</p>
<ol>
<li>先確保要運行的機器有OpenJDK1.8或更高的版本</li>
<li><a target="_blank" rel="noopener" href="https://www.keycloak.org/downloads.html">Keycloak官方網站</a>下載最新的Keycloak realease版本</li>
</ol>
<p><strong>windows</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\standalone.bat</span><br></pre></td></tr></table></figure>
<p><strong>linux</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;standalone.sh</span><br></pre></td></tr></table></figure>
<p>Keycloak默認使用<strong>H2資料庫</strong>儲存數據，位於<code>standalone/data</code>目錄中。</p>
<p>此資料庫並不適用於Production環境，Keycloak官方強烈建議我們將其替換為更利於Productio環境的外部數據庫，例如PostgreSQL。</p>
<p>可以從<a target="_blank" rel="noopener" href="https://www.keycloak.org/docs/latest/server_installation/#_database">官方文檔</a>中獲取有關設置Keycloak數據庫的更多詳細信息。</p>
<h2 id="建立初始化Admin-User"><a href="#建立初始化Admin-User" class="headerlink" title="建立初始化Admin User"></a>建立初始化Admin User</h2><p>Keycloak不附帶<strong>初始admin</strong>用戶，這意味著在開始使用Keycloak之前，您需要創建一個admin用戶。</p>
<p>打開<a target="_blank" rel="noopener" href="http://localhost:8080/auth">http://localhost:8080/auth</a>並填寫創建初始管理表單，用戶名為admin，密碼為password。</p>
<p><img src="https://i.imgur.com/3GNGILZ.png"></p>
<p>單擊創建並進入<strong>admin console</strong>，然後使用剛剛創建的admin登錄。</p>
<p><img src="https://i.imgur.com/c5dRXaZ.png"></p>
<p>登錄後Keycloak顯示的第一個屏幕是<strong>Master Realm</strong>詳細信息。</p>
<p><img src="https://i.imgur.com/7nZSwLR.png"></p>
<ul>
<li>Keycloak中的<strong>realm</strong>就像一個容器，其中包含並隔離user、role、group和client的集合。</li>
<li>Keycloak帶有一個預先創建的Master realm。</li>
<li>建議不要使用Master realm管理組織中user和application。</li>
<li>創建和管理其他realm，為admin保留對Master realm的使用。</li>
</ul>
<p><img src="https://i.imgur.com/5iS9L10.png"></p>
<h2 id="建立Realms"><a href="#建立Realms" class="headerlink" title="建立Realms"></a>建立Realms</h2><p>我們將需要一個realm來管理我們的Spring Boot REST服務使用的user，role和client。</p>
<p>因此，讓我們建立第一個realm。</p>
<p>將鼠標懸停在左上角顯示”Master”的下拉菜單上，然後單擊”Add realm”按鈕。</p>
<p><img src="https://i.imgur.com/sFDqA9O.png"></p>
<p>我們將第一個realm命名為demo：</p>
<p><img src="https://i.imgur.com/LSYaOT8.png"></p>
<p>點擊create，將會被定向到創建的realm詳細信息頁面，可以在這進一步配置realm。</p>
<p><img src="https://i.imgur.com/WhYm21L.png"></p>
<h2 id="建立Roles"><a href="#建立Roles" class="headerlink" title="建立Roles"></a>建立Roles</h2><p>role對user進行分類。在應用程序中，<strong>訪問資源的權限通常授予role而不是user</strong>。</p>
<p>Admin、User和Manager都是組織中可能存在的典型角色。</p>
<p>要建立role，請單擊左側的”Roles”，然後點擊頁面上的”Add Role”按鈕。</p>
<p><img src="https://i.imgur.com/7MM55ib.png"></p>
<p>我們將role命名為spring-user，然後點擊save。</p>
<p><img src="https://i.imgur.com/sH6EtKT.png"></p>
<h2 id="建立Users"><a href="#建立Users" class="headerlink" title="建立Users"></a>建立Users</h2><h3 id="建立User基本資料"><a href="#建立User基本資料" class="headerlink" title="建立User基本資料"></a>建立User基本資料</h3><p>單擊左側的”Users”，然後點擊”Add User”按鈕。</p>
<p><img src="https://i.imgur.com/hSbshmr.png"></p>
<p>將username填寫為Steven<code>(登入的account)</code>，將First Name填寫為Steven，並保留其他所有默認設置。</p>
<p>確保”User Enabled”為”on”。點擊save建立第一個user</p>
<p><img src="https://i.imgur.com/MNP17PY.png"></p>
<h3 id="為User設置密碼"><a href="#為User設置密碼" class="headerlink" title="為User設置密碼"></a>為User設置密碼</h3><p>Steven需要密碼才能登錄Keycloak，所以需要為Steven創建一個密碼。</p>
<p>點擊”Credentials”標籤，然後在密碼和確認密碼輸入<em>mypassword</em>。</p>
<p>且設置<strong>Temporary</strong>為<strong>OFF</strong>，以便在下次登錄時無需更改密碼。</p>
<p>點擊”Set Password”以保存Steven的密碼憑證。</p>
<p><img src="https://i.imgur.com/fg1mWxz.png"></p>
<h3 id="分配Role給User"><a href="#分配Role給User" class="headerlink" title="分配Role給User"></a>分配Role給User</h3><p>將之前創建的role: <code>spring-user</code>分配給Steven。</p>
<p>為此，請點擊”Role Mappings”選項，選擇spring-user角色，然後點擊”Add Selected”。</p>
<p><img src="https://i.imgur.com/TCFK9gy.png"></p>
<h2 id="建立Clients"><a href="#建立Clients" class="headerlink" title="建立Clients"></a>建立Clients</h2><h3 id="Client基本資料建立"><a href="#Client基本資料建立" class="headerlink" title="Client基本資料建立"></a>Client基本資料建立</h3><blockquote>
<p>Clients are entities that will request the authentication of a user.</p>
</blockquote>
<p>Client有兩種形式。</p>
<ol>
<li>第一種類型的Client是想要參與SSO的應用程式，這些Client只希望Keycloak為他們提供安全性。</li>
<li>另一種Client是請求訪問令牌的Client，以便它可以代表已認證的用戶調用其他服務。</li>
</ol>
<p>我們將創建一個Client用於保護我們的Spring Boot REST服務。</p>
<p>點擊左側的”<strong>Clients</strong>“，然後點選”<strong>Create</strong>“。</p>
<p><img src="https://i.imgur.com/E66DlEQ.png"></p>
<p>在表單中，將Client Id填寫為<strong>spring-boot</strong>，為Client Protocol選擇<strong>OpenID Connect</strong>，接著點選Save。</p>
<p><img src="https://i.imgur.com/HtT11cE.png"></p>
<h3 id="更改Access-Type及Authorization-Enabled"><a href="#更改Access-Type及Authorization-Enabled" class="headerlink" title="更改Access Type及Authorization Enabled"></a>更改Access Type及Authorization Enabled</h3><p>在Client的Settings頁面中，我們需要將<strong>Access Type</strong>更改為<code>confidential</code>，而不是默認的<code>public</code>(不需要Client Secret)。存檔之前，請打開”<strong>Authorization Enabled</strong>“開關。</p>
<p><img src="https://i.imgur.com/UGSiFEc.png"></p>
<h3 id="Client-Secret"><a href="#Client-Secret" class="headerlink" title="Client Secret"></a>Client Secret</h3><p>在Client的Credentials頁面中，先將Secret內容複製出來，下面內容會使用到</p>
<p><img src="https://i.imgur.com/W7IuZY1.png"></p>
<h2 id="拿取Access-Token"><a href="#拿取Access-Token" class="headerlink" title="拿取Access Token"></a>拿取Access Token</h2><p>Client通過使用HTTP POST方法向Keycloak中的Token endpoint發出<strong>Token交換請求</strong>來請求安全令牌。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;auth&#x2F;realms&#x2F;&#123;realm&#125;&#x2F;protocol&#x2F;openid-connect&#x2F;token</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Keycloak中的Token交換請求是<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8693">IETF</a>上<strong>OAuth 2.0Token交換</strong>規範的寬鬆實現。</p>
</li>
<li><p><strong>OpenID Connect</strong> Token endpoint 上的簡單授予類型調用。</p>
</li>
<li><p>Keycloak使用”<strong>application/x-www-form-urlencoded</strong>“格式和UTF-8字符編碼來接受HTTP請求實體中的參數。</p>
</li>
</ul>
<p>打開Postman，建立對<code>http://localhost:8080/auth/realms/demo/protocol/openid-connect/token</code> POST請求</p>
<p><img src="https://i.imgur.com/NDXsvJF.png"></p>
<p>會收到帶有<strong>Access Token</strong>和<strong>Refresh Token</strong>以及其他附帶詳細信息的JSON Response。</p>
<p><img src="https://i.imgur.com/vFO75lm.png"></p>
<p>將接收到的Access Token作為Bearer Token放置在Authorization Header中，就可以在受到Keycloak安全保護的REST API進行請求:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers: &#123;</span><br><span class="line">     &#39;Authorization&#39;: &#39;Bearer &#39; + &#123;access_token&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>從Keycloak的<strong>Admin console</strong>中，進到spring-boot的Client詳細資訊，然後點選”<strong>Sessions</strong>“選項。您將看到Steven的登錄session。</p>
<p><img src="https://i.imgur.com/wWeya3q.png"></p>
<p>點擊Steve進到User詳細資訊，然後點選”Sessions”選項。在”Sessions”選項卡下，有一些選項可用於<strong>註銷</strong>特定會話或<strong>註銷所有會話</strong>。</p>
<p><img src="https://i.imgur.com/n5fT74P.png"></p>
<p>我們已經配置了Keycloak並能夠通過Postman請求Access Token，下一步是創建<strong>Spring Boot REST服務</strong>並使用Keycloak保護它。</p>
<h1 id="建立一個Spring-Boot應用程序"><a href="#建立一個Spring-Boot應用程序" class="headerlink" title="建立一個Spring Boot應用程序"></a>建立一個Spring Boot應用程序</h1><p>使用<a target="_blank" rel="noopener" href="https://start.spring.io/">Spring Initializr</a>網站生成具有Spring Boot 2.x依賴項的項目。還需要Spring Boot Starter Web 模塊</p>
<p><img src="https://i.imgur.com/jYHeijY.png"></p>
<p>接下來，創建一個@RestController MessagingRestController Class，該Class將getMessage()方法公開為/user/message上的HTTP GET請求。此方法將返回”Hello, User”字串。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagingRestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(path = &quot;/user/message&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUserMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello, User&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>application.yaml中配置server.port</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<p>現在我們的REST服務已經可以運行了，我們需要使用Keycloak保護它。</p>
<h1 id="使用Keycloak保護Spring-Boot-REST服務"><a href="#使用Keycloak保護Spring-Boot-REST服務" class="headerlink" title="使用Keycloak保護Spring Boot REST服務"></a>使用Keycloak保護Spring Boot REST服務</h1><p>為了保護您的Spring Boot REST服務，必須將Spring Boot的<strong>Keycloak Adpater</strong>添加到服務中。</p>
<p>build.gradle</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">	set(<span class="string">&#x27;keycloakVersion&#x27;</span>, <span class="string">&#x27;12.0.1&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">	imports &#123;</span><br><span class="line">		mavenBom <span class="string">&quot;org.keycloak.bom:keycloak-adapter-bom:$&#123;keycloakVersion&#125;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">&#x27;org.keycloak:keycloak-spring-boot-starter&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接著將keycloak相關內容配置到application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keycloak:</span></span><br><span class="line">  <span class="attr">auth-server-url:</span> <span class="string">http://localhost:8080/auth</span></span><br><span class="line">  <span class="attr">realm:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">resource:</span> <span class="string">spring-boot</span></span><br><span class="line">  <span class="attr">credentials:</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">86ef845e-735a-42aa-84c7-fac294c359ad</span></span><br><span class="line">  <span class="attr">bearer-only:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>auth-server-url: Keycloak服務器的URL</li>
<li>realm: 在keycloak所建立的realm</li>
<li>resource: 在keycloak所建立的Client Id</li>
<li>secret: 在keycloak所建立的Client Secret</li>
<li>only-bearer-only: 必須為true，以便Adpater不會嘗試對用戶進行身份驗證，而僅驗證Access Token</li>
</ul>
<p>再讓我們為應用程式增加security-constraints<code>(安全性約束)</code>。此配置非常重要，因為Keycloak Adapter將根據我們的配置允許或拒絕對我們資源的訪問請求</p>
<p>下列例子為: 確保對URL:/user/*的每個請求，僅在該請求的用戶是具有spring-user角色的已認證用戶時才被授權使用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keycloak:</span></span><br><span class="line">  <span class="attr">security-constraints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">auth-roles:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spring-user</span></span><br><span class="line">      <span class="attr">security-collections:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> </span><br><span class="line">        <span class="attr">patterns:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/user/*</span></span><br></pre></td></tr></table></figure>
<p>在運行服務之前，讓我們打開Keycloak的DEBUG日誌記錄級別，以在console中查看更多詳細信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.keycloak:</span> <span class="string">TRACE</span></span><br></pre></td></tr></table></figure>
<h2 id="Test-HTTP-GET-User-Message"><a href="#Test-HTTP-GET-User-Message" class="headerlink" title="Test HTTP GET User Message"></a>Test HTTP GET User Message</h2><h3 id="Role-spring-user"><a href="#Role-spring-user" class="headerlink" title="Role spring-user"></a>Role spring-user</h3><p>打開postman，URL輸入<code>http://localhost:8000/user/message</code>，HTTP Method為GET<br>再點擊”Authorization”標籤，然後選擇Bearer Token，將之前如下圖示中response的access_token貼上Token欄位裡。</p>
<ol>
<li>使用者Steven驗證</li>
</ol>
<p><img src="https://i.imgur.com/LcXn2sM.png"></p>
<ol start="2">
<li>將上圖的access_token，貼入下圖Token欄位中</li>
</ol>
<p><img src="https://i.imgur.com/WlKirk0.png"></p>
<ol start="3">
<li>點選”Send”過後，會收到 “Hello, User” response</li>
</ol>
<p><img src="https://i.imgur.com/KBPLQkc.png"></p>
<p>在Console中，會看到keycloak日誌紀錄</p>
<p><img src="https://i.imgur.com/azfW1CZ.png"></p>
<h3 id="Role-spring-admin"><a href="#Role-spring-admin" class="headerlink" title="Role spring-admin"></a>Role spring-admin</h3><p>我們將使用新role和user對Keycloak進行更多配置，以演示我們為其他請求URL定義安全約束。</p>
<p>回到keycloak admin console，建立一個新的Role: <code>spring-admin</code></p>
<p><img src="https://i.imgur.com/C5RhXU5.png"></p>
<p>建立新的User: <strong>Dave</strong>並設置密碼，且授予<strong>spring-admin</strong>角色</p>
<p><img src="https://i.imgur.com/0Zh2NNo.png"></p>
<p><img src="https://i.imgur.com/LVoVTJu.png"></p>
<p>回到spring應用程式中，建立一個getAdminMessage endpoint</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(path = &quot;/admin/message&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAdminMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hello, Admin&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後，向我們的應用程序添加另一個安全約束，以授權具有spring-admin角色的用戶訪問URL /admin/*請求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keycloak:</span></span><br><span class="line">  <span class="attr">security-constraints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">auth-roles:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spring-user</span></span><br><span class="line">      <span class="attr">security-collections:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">          <span class="attr">patterns:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/user/*</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">auth-roles:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">spring-admin</span></span><br><span class="line">      <span class="attr">security-collections:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">          <span class="attr">patterns:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/user/*</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/admin/*</span></span><br></pre></td></tr></table></figure>
<p>現在我們使用Steven的token對/admin/message進行請求</p>
<p>此請求被拒絕，因為我們尚未授予spring-user角色訪問請求/admin/*的權限。<br><img src="https://i.imgur.com/NSQjvjO.png"></p>
<p>讓我們換回用Dave的token，來對/admin/message進行請求，將能成功進行請求<br><img src="https://i.imgur.com/6FKkNbw.png"></p>
<p><img src="https://i.imgur.com/H1PDuxz.png"></p>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><ul>
<li>了解到Keycloak是一個現代的身份和訪問管理系統，提供了許多現成的功能。</li>
<li>還學習瞭如何使用realm、role、User和Client來設置Keycloak。</li>
<li>最後，我們學習如何配置Spring Boot REST服務以利用Keycloak認證和授權所有請求。</li>
</ul>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://codeburst.io/securing-spring-boot-rest-services-using-keycloak-without-writing-code-7c47ab72fb9d">https://codeburst.io/securing-spring-boot-rest-services-using-keycloak-without-writing-code-7c47ab72fb9d</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>使用Keycloak保護Spring Boot REST服務</p><p><a href="https://limitcycle.github.io/2021/01/09/spring-boot-with-keycloak/">https://limitcycle.github.io/2021/01/09/spring-boot-with-keycloak/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>limitcycle</p></div></div><div class="level-item is-narrow"><div><h6>發表於</h6><p>2021-01-09</p></div></div><div class="level-item is-narrow"><div><h6>更新於</h6><p>2021-01-18</p></div></div><div class="level-item is-narrow"><div><h6>許可協議</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/spring/">spring</a><a class="link-muted mr-2" rel="tag" href="/tags/keycloak/">keycloak</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/11/keycloak-authorization-services/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Keycloak授權服務</span></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">文章目錄</h3><ul class="menu-list"><li><a class="level is-mobile" href="#什麼是Keycloak"><span class="level-left"><span class="level-item">1</span><span class="level-item">什麼是Keycloak</span></span></a></li><li><a class="level is-mobile" href="#設置Keycloak"><span class="level-left"><span class="level-item">2</span><span class="level-item">設置Keycloak</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#建立初始化Admin-User"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">建立初始化Admin User</span></span></a></li><li><a class="level is-mobile" href="#建立Realms"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">建立Realms</span></span></a></li><li><a class="level is-mobile" href="#建立Roles"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">建立Roles</span></span></a></li><li><a class="level is-mobile" href="#建立Users"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">建立Users</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#建立User基本資料"><span class="level-left"><span class="level-item">2.4.1</span><span class="level-item">建立User基本資料</span></span></a></li><li><a class="level is-mobile" href="#為User設置密碼"><span class="level-left"><span class="level-item">2.4.2</span><span class="level-item">為User設置密碼</span></span></a></li><li><a class="level is-mobile" href="#分配Role給User"><span class="level-left"><span class="level-item">2.4.3</span><span class="level-item">分配Role給User</span></span></a></li></ul></li><li><a class="level is-mobile" href="#建立Clients"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">建立Clients</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Client基本資料建立"><span class="level-left"><span class="level-item">2.5.1</span><span class="level-item">Client基本資料建立</span></span></a></li><li><a class="level is-mobile" href="#更改Access-Type及Authorization-Enabled"><span class="level-left"><span class="level-item">2.5.2</span><span class="level-item">更改Access Type及Authorization Enabled</span></span></a></li><li><a class="level is-mobile" href="#Client-Secret"><span class="level-left"><span class="level-item">2.5.3</span><span class="level-item">Client Secret</span></span></a></li></ul></li><li><a class="level is-mobile" href="#拿取Access-Token"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">拿取Access Token</span></span></a></li></ul></li><li><a class="level is-mobile" href="#建立一個Spring-Boot應用程序"><span class="level-left"><span class="level-item">3</span><span class="level-item">建立一個Spring Boot應用程序</span></span></a></li><li><a class="level is-mobile" href="#使用Keycloak保護Spring-Boot-REST服務"><span class="level-left"><span class="level-item">4</span><span class="level-item">使用Keycloak保護Spring Boot REST服務</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Test-HTTP-GET-User-Message"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Test HTTP GET User Message</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Role-spring-user"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">Role spring-user</span></span></a></li><li><a class="level is-mobile" href="#Role-spring-admin"><span class="level-left"><span class="level-item">4.1.2</span><span class="level-item">Role spring-admin</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#結論"><span class="level-left"><span class="level-item">5</span><span class="level-item">結論</span></span></a></li><li><a class="level is-mobile" href="#參考資料"><span class="level-left"><span class="level-item">6</span><span class="level-item">參考資料</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-11T03:33:43.000Z">2021-01-11</time></p><p class="title"><a href="/2021/01/11/keycloak-authorization-services/">Keycloak授權服務</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-09T08:33:29.000Z">2021-01-09</time></p><p class="title"><a href="/2021/01/09/spring-boot-with-keycloak/">使用Keycloak保護Spring Boot REST服務</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">標籤</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/keycloak/"><span class="tag">keycloak</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">limitcycle&#039;s blog</a><p class="is-size-7"><span>&copy; 2021 limitcycle</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-TW");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="回到頁首" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="請輸入關鍵字..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"請輸入關鍵字...","untitled":"(無標題)","posts":"文章","pages":"頁面","categories":"分類","tags":"標籤"});
        });</script></body></html>